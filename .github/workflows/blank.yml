name: Build Android ARM64 Kernel + Module

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    # env در سطح job تا بین steps پایدار بمونه
    env:
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
      O: ${{ github.workspace }}/kernel/out

    steps:
      - name: Checkout kernel source (Exynos850 v4.19.120)
        uses: actions/checkout@v4
        with:
          repository: rsuntkOrgs/kernel_samsung_exynos850
          ref: v4.19.120
          path: kernel

      - name: Checkout defconfig repo (contains exlinux_defconfig)
        uses: actions/checkout@v4
        with:
          repository: rasolarmand114-tech/M
          path: config_repo

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev dwarves git \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Prepare output dir and copy exlinux_defconfig
        run: |
          # make sure the O= directory exists and copy the defconfig there
          mkdir -p "$O"
          cp config_repo/exlinux_defconfig "$O/.config"
          echo ">>> kernel/out contents:"
          ls -la kernel/out || true

      - name: Show environment (debug)
        run: |
          echo "ARCH=$ARCH"
          echo "CROSS_COMPILE=$CROSS_COMPILE"
          echo "O=$O"
          uname -a
          free -h
          nproc

      - name: Build kernel
        run: |
          # build kernel (uses O= path from env)
          make -C kernel O="$O" -j$(nproc)

      - name: Build custom module (if exists)
        run: |
          if [ -d "${{ github.workspace }}/my_module" ]; then
            echo "Building my_module..."
            make -C kernel O="$O" M="${{ github.workspace }}/my_module" ARCH="$ARCH" CROSS_COMPILE="$CROSS_COMPILE" modules
          else
            echo "No my_module directory found; skipping module build."
          fi

      - name: Collect artifacts to single folder
        run: |
          mkdir -p artifacts
          # copy kernel image if present (common path for arm64)
          if [ -f "$O/arch/arm64/boot/Image" ]; then
            cp "$O/arch/arm64/boot/Image" artifacts/
          fi
          # copy System.map and .config for debugging
          if [ -f "$O/System.map" ]; then
            cp "$O/System.map" artifacts/ || true
          fi
          if [ -f "$O/.config" ]; then
            cp "$O/.config" artifacts/ || true
          fi
          # copy modules .ko if any were built
          if compgen -G "${{ github.workspace }}/my_module/*.ko" > /dev/null 2>&1; then
            cp "${{ github.workspace }}/my_module/"*.ko artifacts/ || true
          fi
          # Also collect built modules installed into kernel modules tree (optional)
          if [ -d "$O/modules" ]; then
            cp -r "$O/modules" artifacts/ || true
          fi
          echo "Artifacts prepared:"
          ls -la artifacts || true

      - name: Upload artifacts (kernel + modules)
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-kernel
          path: artifacts/**
