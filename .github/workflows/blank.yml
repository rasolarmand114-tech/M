name: Build Android ARM64 Kernel (GCC-only, robust)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      # بعد از extract، این prefix باید به bin/ آدرس دهی کنه. در صورت استفاده از apt، همین keep میمونه.
      CROSS_PREFIX: /usr/bin/aarch64-linux-gnu-
      # اگر میخوای از Linaro tarball استفاده کنی، بعد از extract به /opt/linaro/bin/aarch64-linux-gnu- اشاره خواهد شد.
      TOOLCHAIN_DIR: ${{ github.workspace }}/toolchain
      OUT_DIR: ${{ github.workspace }}/out

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: rsuntkOrgs/kernel_samsung_exynos850
          ref: v4.19.120
          path: kernel

      - name: Checkout defconfig repo
        uses: actions/checkout@v4
        with:
          repository: rasolarmand114-tech/M
          path: config_repo

      - name: Install base build packages (no clang)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libssl-dev libelf-dev dwarves wget xz-utils \
            gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      # OPTIONAL: get a specific Linaro toolchain (recommended for reproducibility)
      - name: Download and extract Linaro toolchain (optional, faster & reproducible)
        run: |
          # Uncomment and set TOOLCHAIN_URL to a Linaro GCC tar.xz if you prefer specific version
          # TOOLCHAIN_URL="https://releases.linaro.org/components/toolchain/binaries/latest-7/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz"
          # mkdir -p "$TOOLCHAIN_DIR"
          # wget -qO /tmp/toolchain.tar.xz "$TOOLCHAIN_URL"
          # tar -xJf /tmp/toolchain.tar.xz -C "$TOOLCHAIN_DIR" --strip-components=1
          # export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          echo "Using distro toolchain (apt). To use Linaro, uncomment TOOLCHAIN_URL lines."

      - name: Prepare output dir and copy defconfig
        run: |
          mkdir -p "$OUT_DIR"
          cp config_repo/exlinux_defconfig "$OUT_DIR/.config"
          echo "Copied defconfig to $OUT_DIR/.config"
          ls -la "$OUT_DIR" || true

      - name: Toolchain checks (verbose)
        run: |
          echo "Check CROSS_PREFIX candidate:"
          echo "CROSS_PREFIX=$CROSS_PREFIX"
          echo "GCC version:"
          ${CROSS_PREFIX}gcc --version || true
          echo "AS version:"
          ${CROSS_PREFIX}as --version || true
          echo "LD version:"
          ${CROSS_PREFIX}ld --version || true
          echo "whereis aarch64-linux-gnu-gcc:"
          which ${CROSS_PREFIX}gcc || true

      - name: Build kernel (force GCC, full overrides)
        run: |
          set -euo pipefail
          export CROSS_COMPILE=${CROSS_PREFIX}
          export ARCH=arm64
          export CC=${CROSS_PREFIX}gcc
          export AS=${CROSS_PREFIX}as
          export LD=${CROSS_PREFIX}ld
          export AR=${CROSS_PREFIX}ar
          export NM=${CROSS_PREFIX}nm
          export OBJCOPY=${CROSS_PREFIX}objcopy
          export OBJDUMP=${CROSS_PREFIX}objdump
          export STRIP=${CROSS_PREFIX}strip
          # Force no LLVM
          export LLVM=0
          echo "Build start: $(date)"; uname -a; nproc; free -h
          # Normal build (parallel)
          make -C kernel O="$OUT_DIR" \
            ARCH=arm64 \
            CROSS_COMPILE="${CROSS_PREFIX}" \
            CC="${CC}" AS="${AS}" LD="${LD}" AR="${AR}" NM="${NM}" \
            OBJCOPY="${OBJCOPY}" OBJDUMP="${OBJDUMP}" STRIP="${STRIP}" LLVM=0 -j$(nproc)
          echo "Build finished: $(date)"

      - name: If failure: rerun with verbose single-job for diagnostics
        if: failure()
        run: |
          echo "Build failed. Rerunning verbose single-job (V=1 -j1) to capture exact invocation..."
          set +e
          export CROSS_COMPILE=${CROSS_PREFIX}
          export ARCH=arm64
          export CC=${CROSS_PREFIX}gcc
          export AS=${CROSS_PREFIX}as
          export LD=${CROSS_PREFIX}ld
          make -C kernel O="$OUT_DIR" ARCH=arm64 CROSS_COMPILE="${CROSS_PREFIX}" CC="${CC}" AS="${AS}" LD="${LD}" V=1 -j1 || true
          # print last 200 lines of make log (if any)
          echo "==== tail of build log ===="
          tail -n 200 "$OUT_DIR"/build.log || true

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -v "$OUT_DIR"/arch/arm64/boot/Image artifacts/ || true
          cp -v "$OUT_DIR"/System.map artifacts/ || true
          cp -v "$OUT_DIR"/.config artifacts/ || true
          # copy built module(s) if user module dir present
          if [ -d "${{ github.workspace }}/my_module" ]; then
            make -C kernel O="$OUT_DIR" M="${{ github.workspace }}/my_module" ARCH=arm64 CROSS_COMPILE="${CROSS_PREFIX}" CC="${CC}" AS="${AS}" LD="${LD}" modules || true
            cp -v "${{ github.workspace }}/my_module/"*.ko artifacts/ || true
          fi
          ls -la artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exynos850-kernel-gcc
          path: artifacts/**
